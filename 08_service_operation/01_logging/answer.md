## ログレベル

### DEBUG

プログラム内で起こっていることに関連するあらゆる情報。プログラマーがデバッグのために書いたメッセージであることが多い。

### INFO

ユーザーが開始したアクションや、スケジュールされたタスクの実行、システムのスタートアップやシャットダウンなどのシステム操作。

### WARN

将来的にエラーになる可能性のある状態。ライブラリの廃止に関する警告、使用可能なリソースの不足、パフォーマンスの低下など。

### ERROR

FATAL を除く全てのエラー状態。

### FATAL

システムをシャットダウンさせる全てのエラー状態。たとえばシステムの起動に 32GB のメモリが必要だが 16GB しか利用できない場合、プログラムは FATAL エラーメッセージを記録し、ただちに終了する。

### ログレベルのメリット

ログメッセージが適切なログレベルに分類されていれば、検索・監視など、多くのログを使ったアクションに役立てることができる。
例えば、不具合の調査でエラーを検索する場合や、特定のログレベルのみ Slack に通知する等。

## アプリケーションログの内容

### 含めるべき情報

一般的には、認証・アカウント管理や重要な情報の操作に関するイベントを記録する。

- ログイン・ログアウト（失敗も含む）
- アカウントロック
- ユーザ登録・削除
- パスワード変更
- 重要情報の参照
- 重要な操作（物品の購入、送金、メール送信など）

### 含めるべきではない情報

流出することでリスクが大きい個人情報などの機密情報（パスワードやクレジットカード情報を含む）はログに含めないようにするか、マスク処理をする。

## ログ出力のタイミング

正常系の処理の完了時は INFO、例外発生時は ERROR で出力する。
処理が完了しないうちに「完了」のログを出力してしまうと、その直後にエラーが起きて整合性が取れなくなる場合があるため、注意が必要である。
[参考: ログ設計指針 - 出力タイミング](https://qiita.com/nanasess/items/350e59b29cceb2f122b3#%E5%87%BA%E5%8A%9B%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0)

## ログの種類

### アクセスログ

主に nginx などの Web サーバで記録される。
ユーザの端末からサーバまでの HTTP リクエストや HTTP レスポンスの内容を保存しておく履歴で、どの API が、どのユーザに、どのような内容で実行されたか、どんな値を返却したかなどを各リクエスト・レスポンスに対して残す。

### アプリケーションログ

EC のシステムであれば、ユーザの商品購入や決済時の処理を記録する。

#### デバッグログ

デバッグ用のログは
生成するとデータ量が膨大になり、パフォーマンスに影響が出る場合もある。
デバッグログは、開発環境やテスト環境で取得すべきもので、本番環境では取得するべきではない。

### エラーログ

エラーログは攻撃の検出に役立つ場合がある。SQL インジェクション攻撃などの試行中には、SQL のエラーやファイルオープンのエラーが発生しやすくなる。これらのエラーは通常時には発生しないはずのものであるため、エラーが続けて発生する場合は、攻撃を疑うべきである。

#### アプリケーションのエラーログ

アプリケーションで発生したエラーを出力する。
画面には「アクセスが集中しているのでしばらく待ってからお試しください」のような利用者向けのメッセージを表示しておき、エラーの詳しい内容や原因はログに出力する。これは、利用者にシステムのエラー内容を表示しても利用者が困惑するだけという理由と、エラーの内容が攻撃者にとってのヒントになる場合があるという理由である。

#### RDBMS のエラーログ

MySQL サーバはプロセスに発生した異常をエラーログに出力する。エラーログのパスは`--log--error`オプションで指定でき、パッケージで MySQL をインストールした場合は付属の my.cnf によって/var/log/mysqld.log に指定されていることが多い。

MySQL のログは SYSTEM, ERROR, WARNING, INFORMATION の 4 レベルに分類されており、デフォルトでは ERROR, WARNING が記録されるようになっている。これは log_error_verbosity の値により制御できる。

| log_error_verbosity の値 | 出力されるログイベント      |
| ------------------------ | --------------------------- |
| 1                        | ERROR                       |
| 2（デフォルト）          | ERROR, WARNING              |
| 3                        | ERROR, WARNING, INFORMATION |

### （フロントエンドの）ユーザーログ

### DB のクエリログ

MySQL では一般クエリーログ（General Query Log）と呼ばれ、mysqld が受け取った全てのクエリーを記録する。
これはアプリケーションのデバッグ用のログであり、デフォルトでは出力しない設定になっている。
